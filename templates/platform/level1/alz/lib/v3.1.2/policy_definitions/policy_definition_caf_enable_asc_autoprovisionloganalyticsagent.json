{
  "name": "Enable-ASC-AutoProvisonLogAnalyticsAgent-CAF",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Enforce auto provisioning of the Log Analytics agent",
    "description": "This policy ensures that the auto provisioning setting for the Log Analytics agent is set to 'On'. This is required for Azure Security Center to collect data from your Azure virtual machines.",
    "metadata": {
      "version": "1.0.0",
      "category": "Security Center",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "The action to take when the policy is evaluated"
        },
        "allowedValues": [
          "DeployIfNotExists"
        ],
        "defaultValue": "DeployIfNotExists"
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Resources/subscriptions"
      },
      "then": {
        "effect": "[parameters('effect')]",
        "details": {
          "type": "Microsoft.Security/autoProvisioningSettings",
          "existenceCondition": {
            "field": "Microsoft.Security/autoProvisioningSettings/autoProvision",
            "not": {
              "equals": "On"
            }
          },
          "properties": {
            "autoProvision": "On"
          }
        }
      }
    }
  }
}
